name: "Staged dependencies action"
description: "Github Actions to implement R development stages for package development"
inputs:
  path:
    description: Path to package's root
    required: false
    default: "."
  new-package:
    description: ""
    required: false
    default: false
  no-check-dependencies:
    description: ""
    required: false
    default: false
  no-check-deprecated:
    description: ""
    required: false
    default: false
  no-check-remotes:
    description: ""
    required: false
    default: false
  no-check-version-num:
    description: ""
    required: false
    default: false
  no-check-R-ver:
    description: ""
    required: false
    default: false
  no-check-pkg-size:
    description: ""
    required: false
    default: false
  no-check-file-size:
    description: ""
    required: false
    default: false
  no-check-bioc-views:
    description: ""
    required: false
    default: false
  no-check-bbs:
    description: ""
    required: false
    default: false
  no-check-description:
    description: ""
    required: false
    default: false
  no-check-namespace:
    description: ""
    required: false
    default: false
  no-check-vignettes:
    description: ""
    required: false
    default: false
  no-check-library-calls:
    description: ""
    required: false
    default: false
  no-check-install-self:
    description: ""
    required: false
    default: false
  no-check-coding-practices:
    description: ""
    required: false
    default: false
  no-check-function-len:
    description: ""
    required: false
    default: false
  no-check-man-doc:
    description: ""
    required: false
    default: false
  no-check-news:
    description: ""
    required: false
    default: false
  no-check-unit-tests:
    description: ""
    required: false
    default: false
  no-check-skip-bioc-tests:
    description: ""
    required: false
    default: false
  no-check-formatting:
    description: ""
    required: false
    default: false
  no-check-CRAN:
    description: ""
    required: false
    default: false
  no-check-bioc-help:
    description: ""
    required: false
    default: false
  build-output-file:
    description: ""
    required: false
  quit-with-status:
    description: ""
    required: false
    default: false
  cache-version:
    description: ""
    required: false
    default: "cache-v1"

branding:
  icon: 'arrow-down'
  color: 'blue'
runs:
  using: "composite"
  steps:
      - name: Set R Library home on Linux
        if: runner.os == 'Linux'
        run: |
          mkdir /__w/_temp/Library
          echo ".libPaths('/__w/_temp/Library')" > ~/.Rprofile
        shell: bash

      - name: Cache R packages
        if: "!contains(github.event.head_commit.message, '/nocache')"
        uses: actions/cache@v2
        with:
          path: /home/runner/work/_temp/Library
          key: ${{ inputs.cache-version }}-${{ runner.os }}-biocversion-${{ hashFiles('.github/depends.Rds') }}
          restore-keys: ${{ inputs.cache-version }}-${{ runner.os }}-biocversion

      - name: Install dependencies
        run: |
          options(repos = c(CRAN = "https://cloud.r-project.org/"))
          ncores <- parallel::detectCores(all.tests = FALSE, logical = TRUE)
          if (!require("BiocManager")) install.packages("BiocManager", upgrade = "never", Ncpus = ncores)
          BiocManager::install("BiocCheck", update = FALSE, ask = FALSE)
        shell: Rscript {0}

      - name: Prepare script options
        run: |
          declare -a options
          test "${INPUT_NEW_PACKAGE}" = "true" && options+=(--new-package)
          test "${INPUT_NO_CHECK_DEPENDENCIES}" = "true" && options+=(--no-check-dependencies)
          test "${INPUT_NO_CHECK_DEPRECATED}" = "true" && options+=(--no-check-deprecated)
          test "${INPUT_NO_CHECK_REMOTES}" = "true" && options+=(--no-check-remotes)
          test "${INPUT_NO_CHECK_VERSION_NUM}" = "true" && options+=(--no-check-version-num)
          test "${INPUT_NO_CHECK_R_VER}" = "true" && options+=(--no-check-R-ver)
          test "${INPUT_NO_CHECK_PKG_SIZE}" = "true" && options+=(--no-check-pkg-size)
          test "${INPUT_NO_CHECK_FILE_SIZE}" = "true" && options+=(--no-check-file-size)
          test "${INPUT_NO_CHECK_BIOC_VIEWS}" = "true" && options+=(--no-check-bioc-views)
          test "${INPUT_NO_CHECK_BBS}" = "true" && options+=(--no-check-bbs)
          test "${INPUT_NO_CHECK_DESCRIPTION}" = "true" && options+=(--no-check-description)
          test "${INPUT_NO_CHECK_NAMESPACE}" = "true" && options+=(--no-check-namespace)
          test "${INPUT_NO_CHECK_VIGNETTES}" = "true" && options+=(--no-check-vignettes)
          test "${INPUT_NO_CHECK_LIBRARY_CALLS}" = "true" && options+=(--no-check-library-calls)
          test "${INPUT_NO_CHECK_INSTALL_SELF}" = "true" && options+=(--no-check-install-self)
          test "${INPUT_NO_CHECK_CODING_PRACTICES}" = "true" && options+=(--no-check-coding-practices)
          test "${INPUT_NO_CHECK_FUNCTION_LEN}" = "true" && options+=(--no-check-function-len)
          test "${INPUT_NO_CHECK_MAN_DOC}" = "true" && options+=(--no-check-man-doc)
          test "${INPUT_NO_CHECK_NEWS}" = "true" && options+=(--no-check-news)
          test "${INPUT_NO_CHECK_UNIT_TESTS}" = "true" && options+=(--no-check-unit-tests)
          test "${INPUT_NO_CHECK_SKIP_BIOC_TESTS}" = "true" && options+=(--no-check-skip-bioc-tests)
          test "${INPUT_NO_CHECK_FORMATTING}" = "true" && options+=(--no-check-formatting)
          test "${INPUT_NO_CHECK_CRAN}" = "true" && options+=(--no-check-CRAN)
          test "${INPUT_NO_CHECK_BIOC_HELP}" = "true" && options+=(--no-check-bioc-help)
          test "${INPUT_BUILD_OUTPUT_FILE}x" = "x" || options+=(--build-output-file ${INPUT_BUILD_OUTPUT_FILE})
          test "${INPUT_QUIT_WITH_STATUS}" = "true" && options+=(--quit-with-status)
          echo "BIOC_OPTIONS=${options[@]}" >> $GITHUB_ENV
        shell: bash

      - name: Run BiocCheck
        run: |
          echo -e "Running: ${GITHUB_ACTION_PATH}/BiocCheck.R ${BIOC_OPTIONS} ${{ inputs.path }}\n\n"
          ${GITHUB_ACTION_PATH}/BiocCheck.R ${BIOC_OPTIONS} ${{ inputs.path }}
        shell: bash
